#!/usr/bin/env bash

if [[ $1 = '--first-run' ]]; then # First run
    xterm -e shebang-welcome
    exit 0
fi

say() {
    fold -s -w 76 <<<"$1" | sed -e 's/^/  /' # wraps text nicely and adds two leading spaces
    sleep "${2-0}"
}

checkconnection() {
    for IFACE in $(ip -o link show | awk -F': ' '{print $2}' | grep -v 'lo'); do doas ip link set dev $IFACE down >/dev/null; doas macchanger -a $IFACE >/dev/null 2>&1; doas ip link set dev $IFACE up >/dev/null; doas iw dev $IFACE set power_save on >/dev/null 2>&1; doas iw dev $IFACE set txpower auto >/dev/null 2>&1; done
    rfkill unblock wifi >/dev/null 2>&1

    local TEXT_CHECKING='Checking internet connection...'
    local TEXT_FAILED='Internet connection check failed!'
    local TEXT_ABORT='Please configure your connection at /etc/wpa_supplicant/wpa_supplicant.conf'
    local TEXT_OK='Internet connection check passed!'

    local -i i attempts=${1-0}

    for ((i = 0; i < attempts || attempts == 0; i++)); do
        say "$TEXT_CHECKING"
        if curl -so - 'https://raw.githubusercontent.com/shebang-linux/.github/refs/heads/main/README.md' &>/dev/null; then
            say "$TEXT_OK" 1
            return 0
        fi
        say "$TEXT_FAILED" 1
        if ((i == attempts)); then # if last attempt
            say "$TEXT_ABORT"
            ((attempts == 1)) && return 1
        fi
        doas sv restart wpa_supplicant >/dev/null 2>&1 && doas sv restart dhcpcd >/dev/null 2>&1
        sleep 10s
    done
}

checkconnection && clear

source /etc/os-release

if [[ "$NAME" == "Shebang Linux" ]]; then
tee <<"EOF"
   _  _   _     ____  _   _ _____ ____    _    _   _  ____
 _| || |_| |   / ___|| | | | ____| __ )  / \  | \ | |/ ___|
|_      _| |   \___ \| |_| |  _| |  _ \ / _ \ |  \| | |  _
|_      _|_|    ___) |  _  | |___| |_) / ___ \| |\  | |_| |
  |_||_| (_)   |____/|_| |_|_____|____/_/   \_\_| \_|\____|

Welcome to Shebang Linux

This is a post-installation script designed to help you configure and get the most latest out of Shebang.
You can run it at a later date by entering the command shebang-welcome in the terminal.

EOF
fi

if cat /proc/cmdline | grep -q -i "label"; then
    echo -e "Load keymap (default: us)" && read -p "> " KEYMAP && setxkbmap $KEYMAP || doas loadkeys $KEYMAP
    doas sed -i -e "s/replaceme/$KEYMAP/" /etc/pacman.d/hooks/set-keyboard-layout-back-to-normal.hook
    doas sed -i -e "s/replaceme/$KEYMAP/" /home/$USER/.config/openbox/autostart
    doas sed -i -e "s/replaceme/$KEYMAP/" /etc/skel/.config/openbox/autostart
    doas sed -i -e "s/replaceme/$KEYMAP/" /root/.config/openbox/autostart

    echo -e "Install Shebang" && read -p $"(y/N) > " YESNO
    if [[ "$YESNO" =~ [Yy] ]]; then
        doas /usr/local/bin/setup-shebang
        read -p $"(y/N) > " YESNO
        [[ "$YESNO" =~ [Yy] ]] && doas reboot -f
    else
        say "Not installing"
    fi
fi

curl -so /home/$USER/.local/bin/shebang-include.cfg https://raw.githubusercontent.com/shebang-linux/shebang-dotfiles/main/.local/bin/shebang-include.cfg

if ! . shebang-include.cfg 2>/dev/null; then
    say "Failed to locate shebang-include.cfg in PATH" >&2
    exit 1
fi

trap 'postinstall' SIGINT && postinstall

openbox --exit || exit 1
