#!/bin/bash -e

usage() {
  echo "Usage: pacman-source PACKAGE1 [PACKAGE2 ...]"
  echo "Example: pacman-source pacman"
  exit 1
}

if [ "$#" -lt 1 ]; then
  usage
fi

for PKG in "$@"; do
  pacman -Ss "^$PKG$" &> /dev/null || { echo "Invalid package."; continue; }

  rm -rfd "/var/lib/pacman/sources/$PKG-PKGBUILD"
  rm -rfd "/var/lib/pacman/sources/$PKG"

  git clone --depth 1 --progress "https://gitea.artixlinux.org/packages/$PKG.git" "/var/lib/pacman/sources/$PKG-PKGBUILD"

  cd "/var/lib/pacman/sources/$PKG-PKGBUILD" && vim .

  makepkg -so --noconfirm

  cd "/var/lib/pacman/sources/$PKG/src" && vim . && cd "/var/lib/pacman/sources/$PKG-PKGBUILD"

  makepkg -ei --noconfirm

  doas pacman -Qqdt && doas pacman -Rddns --noconfirm $(pacman -Qqdtt)
done
